<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSL Semicolon - 手話単語分割</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
          "lucide": "https://unpkg.com/lucide@latest"
        }
      }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
      // ブラウザ環境(GitHub Pages等)での実行時に process is not defined エラーを防ぐためのポリフィル
      // 注意: 公開環境にデプロイする場合は、APIキーの取扱いに十分注意してください。
      if (typeof process === "undefined") {
        window.process = {
          env: {
            // ここにAPIキーを設定するか、環境変数から注入されるようにしてください
            API_KEY: "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" 
          }
        };
      }
    </script>

    <style>
      /* Custom font */
      body {
        font-family: 'Noto Sans JP', sans-serif;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; 
      }

      /* Animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translate3d(0, 20px, 0);
        }
        to {
          opacity: 1;
          transform: translate3d(0, 0, 0);
        }
      }

      .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
      }

      /* Tooltip handling */
      .segment-card:hover .segment-tooltip {
        opacity: 1;
        pointer-events: auto;
      }
    </style>
  <link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-slate-50 text-slate-900 font-sans pb-20">
    
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
      <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="bg-teal-600 p-2 rounded-lg text-white">
            <i data-lucide="hand-metal"></i>
          </div>
          <div>
            <h1 class="font-bold text-xl text-slate-800 tracking-tight">JSL Semicolon</h1>
            <p class="text-xs text-slate-500 font-medium">手話単語分割 AIアシスタント</p>
          </div>
        </div>
        <div class="text-sm font-medium text-slate-500 hidden sm:block">
          Powered by Gemini 2.5 Flash
        </div>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
      
      <!-- Hero Section -->
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-slate-800 mb-3">
          日本語を手話の文法へ
        </h2>
        <p class="text-slate-600 max-w-xl mx-auto">
          入力された文章を解析し、日本手話（JSL）の文法に基づいた単語の並び順と区切りに変換します。
        </p>
      </div>

      <!-- Input Section -->
      <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 sm:p-6 mb-6">
        <form id="analysisForm" class="flex flex-col gap-4">
          <div class="relative">
            <textarea
              id="inputText"
              placeholder="ここに日本語の文章を入力するか、マイクボタンを押して話しかけてください..."
              class="w-full h-32 p-4 text-lg rounded-xl border-2 border-slate-100 focus:border-teal-500 focus:ring-4 focus:ring-teal-500/10 transition-all outline-none resize-none bg-slate-50 text-slate-800 placeholder:text-slate-400"
            ></textarea>
            <div class="absolute bottom-3 right-3 flex gap-2">
              <button
                type="button"
                id="micBtn"
                class="p-2 rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300 transition-all duration-300"
                title="音声入力を開始"
              >
                <i data-lucide="mic"></i>
              </button>
              <button
                type="button"
                id="clearBtn"
                class="p-2 rounded-full bg-slate-200 text-slate-600 hover:bg-slate-300 transition-colors"
                title="クリア"
                disabled
              >
                <i data-lucide="eraser"></i>
              </button>
            </div>
          </div>

          <button
            type="submit"
            id="submitBtn"
            disabled
            class="flex items-center justify-center gap-2 w-full py-4 rounded-xl font-bold text-lg text-white shadow-md transition-all duration-300 transform bg-slate-300 cursor-not-allowed"
          >
            <i data-lucide="send" id="submitIcon"></i>
            <span id="submitText">手話単語に分割する</span>
          </button>
        </form>
      </section>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 text-red-700 border border-red-200 rounded-xl flex items-center gap-2 animate-pulse">
        <span class="font-bold">Error:</span> <span id="errorText"></span>
      </div>

      <!-- Result Section -->
      <section id="resultSection" class="hidden space-y-6 animate-fade-in-up">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="play-circle" class="text-teal-500"></i>
            手話表現の順序
          </h2>
          <span id="politeTranslation" class="hidden text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
            <!-- Polite translation will be injected here -->
          </span>
        </div>

        <div id="segmentsContainer" class="bg-slate-100/50 p-6 rounded-2xl border border-slate-200 min-h-[200px]">
          <div id="segmentsList" class="flex flex-wrap gap-3 items-stretch">
            <!-- Segments will be injected here -->
          </div>
        </div>

        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex gap-3 text-sm text-blue-800">
          <i data-lucide="alert-circle" class="shrink-0 text-blue-500"></i>
          <div>
            <p class="font-bold mb-1">ヒント</p>
            <ul class="list-disc list-inside space-y-1 opacity-90">
              <li>手話では助詞（てにをは）はしばしば省略され、表情やあごの動きで表現されます。</li>
              <li>点線で表示されているカードは、省略可能または文脈に含まれる要素です。</li>
              <li>「？」や「否定」などの文末表現は、直前の単語と一緒に表情で表すことが重要です。</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Placeholder / Empty State -->
      <div id="placeholderState" class="mt-12 grid grid-cols-1 sm:grid-cols-3 gap-6 opacity-50">
         <div class="p-4 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center text-center">
            <div class="h-12 w-20 bg-slate-200 rounded-md mb-2"></div>
            <p class="text-sm font-bold text-slate-400">名詞・動詞抽出</p>
         </div>
         <div class="p-4 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center text-center">
            <div class="h-12 w-20 bg-slate-200 rounded-md mb-2"></div>
            <p class="text-sm font-bold text-slate-400">不要語省略</p>
         </div>
         <div class="p-4 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center text-center">
            <div class="h-12 w-20 bg-slate-200 rounded-md mb-2"></div>
            <p class="text-sm font-bold text-slate-400">文法並べ替え</p>
         </div>
      </div>

    </main>

    <script type="module">
      import { GoogleGenAI, Type } from "@google/genai";

      // --- Configuration & Initialization ---
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

      // Segment Types matching the backend schema
      const SegmentType = {
        NOUN: '名詞',
        VERB: '動詞',
        ADJECTIVE: '形容詞',
        PARTICLE: '助詞',
        ADVERB: '副詞',
        EXPRESSION: '表現',
        OTHER: 'その他'
      };

      const jslSchema = {
        type: Type.OBJECT,
        properties: {
          segments: {
            type: Type.ARRAY,
            description: "List of word segments adapted for Japanese Sign Language structure.",
            items: {
              type: Type.OBJECT,
              properties: {
                originalText: { type: Type.STRING },
                jslGloss: { type: Type.STRING },
                type: {
                  type: Type.STRING,
                  enum: Object.values(SegmentType)
                },
                explanation: { type: Type.STRING }
              },
              required: ["originalText", "jslGloss", "type"]
            }
          },
          politeTranslation: { type: Type.STRING }
        },
        required: ["segments"]
      };

      // --- DOM Elements ---
      const inputText = document.getElementById('inputText');
      const micBtn = document.getElementById('micBtn');
      const clearBtn = document.getElementById('clearBtn');
      const submitBtn = document.getElementById('submitBtn');
      const submitIcon = document.getElementById('submitIcon');
      const submitText = document.getElementById('submitText');
      const errorMessage = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      const resultSection = document.getElementById('resultSection');
      const segmentsList = document.getElementById('segmentsList');
      const politeTranslation = document.getElementById('politeTranslation');
      const placeholderState = document.getElementById('placeholderState');

      // --- State ---
      let isListening = false;
      let recognition = null;

      // --- Initialize Icons ---
      if (window.lucide) {
        window.lucide.createIcons();
      }

      // --- Speech Recognition Setup ---
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onresult = (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            }
          }
          if (finalTranscript) {
            inputText.value += finalTranscript;
            updateButtonState();
          }
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error', event.error);
          stopListening();
        };
        
        recognition.onend = () => {
          if (isListening) {
            stopListening();
          }
        };
      } else {
        micBtn.style.display = 'none';
      }

      function startListening() {
        if (!recognition) return;
        try {
          recognition.start();
          isListening = true;
          micBtn.innerHTML = `<i data-lucide="mic-off"></i>`;
          micBtn.classList.remove('bg-slate-200', 'text-slate-600');
          micBtn.classList.add('bg-red-500', 'text-white', 'shadow-lg', 'shadow-red-500/30', 'animate-pulse');
          if (window.lucide) window.lucide.createIcons();
        } catch (e) {
          console.error(e);
        }
      }

      function stopListening() {
        if (!recognition) return;
        recognition.stop();
        isListening = false;
        micBtn.innerHTML = `<i data-lucide="mic"></i>`;
        micBtn.classList.add('bg-slate-200', 'text-slate-600');
        micBtn.classList.remove('bg-red-500', 'text-white', 'shadow-lg', 'shadow-red-500/30', 'animate-pulse');
        if (window.lucide) window.lucide.createIcons();
      }

      // --- Logic ---
      function updateButtonState() {
        const hasText = inputText.value.trim().length > 0;
        clearBtn.disabled = !hasText;
        submitBtn.disabled = !hasText;
        
        if (hasText) {
          submitBtn.classList.remove('bg-slate-300', 'cursor-not-allowed');
          submitBtn.classList.add('bg-gradient-to-r', 'from-teal-500', 'to-emerald-500', 'hover:from-teal-600', 'hover:to-emerald-600', 'hover:shadow-lg', 'hover:-translate-y-0.5', 'active:translate-y-0');
        } else {
          submitBtn.classList.add('bg-slate-300', 'cursor-not-allowed');
          submitBtn.classList.remove('bg-gradient-to-r', 'from-teal-500', 'to-emerald-500', 'hover:from-teal-600', 'hover:to-emerald-600', 'hover:shadow-lg', 'hover:-translate-y-0.5', 'active:translate-y-0');
        }
      }

      async function analyzeText(text) {
        setLoading(true);
        resultSection.classList.add('hidden');
        placeholderState.classList.add('hidden');
        errorMessage.classList.add('hidden');

        const prompt = `
          あなたは日本手話(JSL)の言語学と翻訳の専門家です。
          ユーザーが入力した日本語の文章を、手話で表現する際の適切な「単語（概念）」の区切りに分解してください。

          以下のルールに従ってください：
          1. 日本手話は助詞（て、に、を、は）を省略したり、表情や位置で表現することが多いです。
          2. 文法はTopic-Comment構造になることがよくあります。
          3. 完了形や否定形は、動詞の後に別のサインとして続くことがあります（例：食べない -> 食べる + 否定）。
          4. 分かりやすいように、単語ごとに分割し、それぞれの「手話単語（グロス）」を提供してください。
          
          入力テキスト: "${text}"
        `;

        try {
          const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: jslSchema,
              temperature: 0.2,
            }
          });

          if (!response.text) {
            throw new Error("AIからの応答がありませんでした。");
          }

          const result = JSON.parse(response.text);
          renderResults(result);
          
        } catch (error) {
          console.error(error);
          errorText.textContent = error.message || "解析中に不明なエラーが発生しました。";
          errorMessage.classList.remove('hidden');
        } finally {
          setLoading(false);
        }
      }

      function getTypeColor(type) {
        switch (type) {
          case SegmentType.NOUN: return 'bg-blue-50 text-blue-700 border-blue-200';
          case SegmentType.VERB: return 'bg-red-50 text-red-700 border-red-200';
          case SegmentType.ADJECTIVE: return 'bg-yellow-50 text-yellow-700 border-yellow-200';
          case SegmentType.PARTICLE: return 'bg-slate-100 text-slate-500 border-slate-200 opacity-75';
          case SegmentType.EXPRESSION: return 'bg-purple-50 text-purple-700 border-purple-200';
          default: return 'bg-gray-50 text-gray-700 border-gray-200';
        }
      }

      function renderResults(result) {
        segmentsList.innerHTML = '';
        
        if (result.politeTranslation) {
          politeTranslation.textContent = `元の意味: ${result.politeTranslation}`;
          politeTranslation.classList.remove('hidden');
        } else {
          politeTranslation.classList.add('hidden');
        }

        result.segments.forEach((segment, index) => {
          const isOmitted = segment.jslGloss.includes('省略') || segment.jslGloss === '' || segment.jslGloss === '()';
          const colorClasses = getTypeColor(segment.type);
          const opacityClasses = isOmitted ? 'opacity-60 grayscale border-dashed' : 'bg-white';
          
          // Create card element
          const card = document.createElement('div');
          card.className = `segment-card relative group flex flex-col justify-between min-w-[100px] max-w-[180px] p-3 rounded-xl border-2 transition-all duration-300 hover:shadow-md hover:-translate-y-1 ${colorClasses} ${opacityClasses}`;
          
          // Type label
          const typeLabel = document.createElement('span');
          typeLabel.className = "text-[10px] font-bold uppercase tracking-wider opacity-70 mb-1";
          typeLabel.textContent = segment.type;
          card.appendChild(typeLabel);
          
          // Gloss
          const glossContainer = document.createElement('div');
          glossContainer.className = "text-center my-1";
          const glossText = document.createElement('div');
          glossText.className = `font-bold text-lg ${isOmitted ? 'line-through text-slate-400' : ''}`;
          glossText.textContent = segment.jslGloss || '—';
          glossContainer.appendChild(glossText);
          card.appendChild(glossContainer);
          
          // Original Text
          const originalTextDiv = document.createElement('div');
          originalTextDiv.className = "text-xs text-center border-t border-current/20 pt-2 mt-1 opacity-80 truncate";
          originalTextDiv.textContent = `「${segment.originalText}」`;
          card.appendChild(originalTextDiv);

          // Tooltip
          if (segment.explanation) {
             const tooltip = document.createElement('div');
             tooltip.className = "segment-tooltip absolute opacity-0 transition-opacity bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-800 text-white text-xs p-2 rounded shadow-lg z-10 pointer-events-none";
             tooltip.innerHTML = `${segment.explanation}<div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>`;
             card.appendChild(tooltip);

             const infoIconDiv = document.createElement('div');
             infoIconDiv.className = "mt-1 flex justify-end";
             infoIconDiv.innerHTML = `<i data-lucide="alert-circle" width="12" height="12" class="opacity-50"></i>`;
             card.appendChild(infoIconDiv);
          }

          segmentsList.appendChild(card);

          // Arrow
          if (index < result.segments.length - 1) {
            const arrowDiv = document.createElement('div');
            arrowDiv.className = "flex items-center justify-center text-slate-300";
            arrowDiv.innerHTML = `<i data-lucide="arrow-right" width="20" stroke-width="3"></i>`;
            segmentsList.appendChild(arrowDiv);
          }
        });

        resultSection.classList.remove('hidden');
        
        // Refresh icons for new elements
        if (window.lucide) window.lucide.createIcons();
      }

      function setLoading(loading) {
        if (loading) {
          submitText.textContent = "分析中...";
          submitIcon.setAttribute('data-lucide', 'sparkles');
          submitIcon.classList.add('animate-spin');
          submitBtn.disabled = true;
        } else {
          submitText.textContent = "手話単語に分割する";
          submitIcon.setAttribute('data-lucide', 'send');
          submitIcon.classList.remove('animate-spin');
          submitBtn.disabled = false;
        }
        if (window.lucide) window.lucide.createIcons();
      }

      // --- Event Listeners ---
      inputText.addEventListener('input', updateButtonState);

      micBtn.addEventListener('click', () => {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      });

      clearBtn.addEventListener('click', () => {
        inputText.value = '';
        stopListening();
        updateButtonState();
        resultSection.classList.add('hidden');
        placeholderState.classList.remove('hidden');
        errorMessage.classList.add('hidden');
      });

      document.getElementById('analysisForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const text = inputText.value.trim();
        if (text) {
          analyzeText(text);
        }
      });

      // Initial state
      updateButtonState();
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
